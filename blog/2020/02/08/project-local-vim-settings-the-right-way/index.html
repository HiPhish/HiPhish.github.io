<!DOCTYPE html>
<html lang="en"><head><meta charset="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/><title>HiPhish's Workshop</title><link rel="stylesheet" href="/css/main.css" type="text/css" media="all"/><link rel="stylesheet" href="/css/local-nav.css" type="text/css" media="all"/><link rel="stylesheet" href="/css/blog.css" type="text/css" media="all"/></head><body><header><nav id="main-navbar"><input type="checkbox" id="main-nav-hamburger" hidden="hidden"/><div><a href="/">HiPhish's Workshop</a><label for="main-nav-hamburger" hidden="hidden"></label></div><ul><li><a href="/grid-framework/">Grid Framework</a><ul><li><a href="/grid-framework/">Overview</a></li><li hidden="hidden"/><li><a href="/grid-framework/features/">Features</a></li><li><a href="/grid-framework/examples/">Examples</a></li><li><a href="/grid-framework/gallery/">Gallery</a></li><li><a href="/grid-framework/showcase/">Showcase</a></li><li><a href="/grid-framework/faq/">FAQ</a></li><li><a href=" /grid-framework/news/">News</a></li><li hidden="hidden"/><li><a href="http://forum.unity3d.com/threads/grid-framework-scripting-and-editor-plugins.144886/">Support</a></li><li hidden="hidden"/><li><a href="https://www.assetstore.unity3d.com/#/content/62498">Buy Now <span class="badge">35$</span></a></li></ul></li><li><a href="/#products">Open Source</a><ul><li><a href="https://gitlab.com/HiPhish/ntfs-clone">NTFS-Clone</a></li><li><a href="https://gitlab.com/HiPhish/IPS-Tools">IPS-Tools</a></li><li><a href="https://gitlab.com/HiPhish/roll">roll</a></li><li><a href="https://github.com/HiPhish/Newton-method">Newton's Method in C</a></li><li><a href="https://github.com/HiPhish/XeenTools">Xeen Tools</a></li><li><a href="https://github.com/HiPhish/Wolf3DExtract">Wolf3D Extract</a></li><li><a href="https://github.com/HiPhish/Game-Source-Documentation">Game Source Documentation</a></li></ul></li><li><a href="/vim/plugins/">Vim/Nvim plugins</a><ul><li><a href="https://gitlab.com/HiPhish/info.vim">Info.vim</a></li><li><a href="https://gitlab.com/HiPhish/repl.nvim">REPL.nvim</a></li><li><a href="https://gitlab.com/HiPhish/quicklisp.nvim">Quicklisp.nvim</a></li><li><a href="https://gitlab.com/HiPhish/jinja.vim">jinja.vim</a></li><li><a href="https://gitlab.com/HiPhish/neovim-guix-channel/">Guix channel</a></li></ul></li><li class="push-end"><a href="/blog/">Blog</a></li><li><a href="/about/">About</a></li></ul></nav></header><div><div class="blog"><nav class="breadcrumbs" aria-label="Breadcrumbs"><ol><li class=""><a href="../../../../">blog</a></li><li class=""><a href="../../../">2020</a></li><li class=""><a href="../../">02</a></li><li class="active">08</li><li class="active">project-local-vim-settings-the-right-way</li></ol></nav><main class="blogpost"><article><h1><a href="." title="permalink to Project-local Vim settings the right way" rel="bookmark">Project-local Vim settings the right way</a></h1><header class="blog-post-header"><p class="blog-post-published">published: <time datetime="2020-02-08">2020-02-08</time></p><p class="blog-post-category">categories: <a href="../../../../categories/vim/">vim</a></p><p class="blog-post-tags">tags: <a href="../../../../tags/vim/">vim</a>, <a href="../../../../tags/rant/">rant</a></p></header><p>Sometimes you want to have a set of Vim settings specific only to a certain
project. There are many tips out there how to achieve such a setup, but most of
them expose the user to serious security risks. I am going to describe the
fundamental problem and how to solve it. TL;DR: use the <a href="https://github.com/MarcWeber/vim-addon-local-vimrc">vim-addon-local-vimrc</a>
plugin.</p><p>Unfortunately there is a very obvious but dangerous solution that gets promoted
on countless blogs and Stack Overflow questions which keep popping up in web
searches. I will first describe this naive solution and what exactly the
problem with it is, then I will outline the proper secure solution.</p><h2 id="The naive solution">The naive solution</h2><p>This is the usual people recommend, which is not secure. We can create a file
in the root directory of the project, give it a predefined name like <code>init.vim</code>
and set up Vim to <code>:source</code> the file when it finds it:</p><pre><code>for fname in ['init.vim', '.init.vim', 'vimrc', '.vimrc']
    if filereadable(fname)
        execute 'source' fname
        break
    endif
endfor
</code></pre><p>This is very bad! Whenever you open <em>any</em> file from a directory containing a
local settings file, the Vim Script file will be sourced. The file could
contain malicious code like</p><pre><code>call system('rm -rf ~')
</code></pre><p>and Vim would execute it unconditionally. You might only want to take a look at
the README file of a project and you end up executing foreign code. Even worse,
if file file name starts with a period character (like <code>.init.vim</code>) you might
not even be aware that the file exists.</p><p>No problem, just <code>:set secure</code> and everything will be fine. It is called
<code>secure</code> for a reason after all, right? Wrong, the <code>secure</code> option is not good
enough, it is still possible to execute arbitrary code:</p><pre><code>call feedkeys(&quot;:!rm -rf ~\n&quot;)
</code></pre><p>An attacker might not even have to go that extra mile, because according to the
manual “On Unix this option is only used if the &quot;.nvimrc&quot; or &quot;.exrc&quot; is not
owned by you” (see <code>:help 'secure'</code>). When you clone a git repository you are
the owner of all its files, and <code>secure</code> does absolutely nothing.</p><h2 id="The secure solution">The secure solution</h2><p>The only way to be on the safe side is to inspect the settings file yourself
before sourcing it. To prevent being caught by surprise when we open a file we
can prompt for confirmation.</p><pre><code>for fname in ['init.vim', '.init.vim', 'vimrc', '.vimrc']
    if filereadable(fname)
        if input('Do you wish to load ' .. fname .. ' ?') == 'yes'
            execute 'source' fname
        endif
        break
    endif
endfor
</code></pre><p>This does defeat automation though, we now have to manually confirm it every
time. If we get used to typing <code>yes</code> every single time we might miss when the
file contents change right under our nose (e.g. after a <code>git pull</code>) and confirm
the use of a now malicious file.</p><p>To solve this issue we need to remember which files have been confirmed and do
not prompt for those as long as the file contents remain unchanged. We can
store our previous choices along with the file hashes in a database of sorts.
When a settings file is detected perform the following steps:</p><ol><li><p>Has the file been previously confirmed or denied? If not, go to step 4.</p></li><li><p>Is the hash of the current file the same as the stored hash? If not, go to
step 4.</p></li><li><p>Go to step 6.</p></li><li><p>Prompt the user.</p></li><li><p>Record the choice along with the current file hash.</p></li><li><p>Source or ignore the file based on the stored settings.</p></li></ol><p>We need to find a sufficiently good hashing algorithm and a way of storing the
choices in a database or file and retrieving them again. The plugin
<a href="https://github.com/MarcWeber/vim-addon-local-vimrc">vim-addon-local-vimrc</a> does all of these things already, so there is no need
to re-invent the wheel.</p><h2 id="Conclusion">Conclusion</h2><ul><li><p>The naive approach is dangerous because of unconditional foreign code
execution (i.e. you think you are only reading a file, but something else
happens in the background)</p></li><li><p>Instead ask the user before sourcing a new or changed file</p></li><li><p>Store the settings to avoid repeated prompting (people form habits and start
accepting things without thinking first)</p></li><li><p>Use a file hash to detect whether a file has changed</p></li><li><p>The <a href="https://github.com/MarcWeber/vim-addon-local-vimrc">vim-addon-local-vimrc</a> plugin implements all of the above steps</p></li></ul></article><nav class="blog-pager"><a href="/blog/2020/02/01/learn-vimscript-in-y-minutes/" rel="previous" style="float: left"><span aria-hidden="true">←</span> Learn Vim Script in Y minutes</a><a href="/blog/2020/02/29/de-bootsrapping-the-workshop-part-2/" rel="next" style="float: right">De-Bootsrapping the workshop, part 2 <span aria-hidden="true">→</span></a></nav></main><nav class="blog-navigation" aria-label="Blog navigation"><aside><span>subscribe:</span> <a href="/blog/rss.xml" type="application/rss+xml">RSS</a></aside><nav><h1><a href="/blog/archive/">archive</a></h1><ul><li><a href="/blog/2023/">2023 (1)</a></li><li><a href="/blog/2022/">2022 (13)</a></li><li><a href="/blog/2021/">2021 (5)</a></li><li><a href="/blog/2020/">2020 (15)</a></li><li><a href="/blog/2019/">2019 (17)</a></li><li><a href="/blog/2018/">2018 (1)</a></li><li><a href="/blog/2017/">2017 (4)</a></li><li><a href="/blog/2016/">2016 (6)</a></li><li><a href="/blog/2015/">2015 (2)</a></li></ul></nav><nav><h1><a href="/blog/categories/">categories</a></h1><ul><li><a href="/blog/categories/misc/">misc (17)</a></li><li><a href="/blog/categories/open-source/">open-source (21)</a></li><li><a href="/blog/categories/organisation/">organisation (13)</a></li><li><a href="/blog/categories/vim/">vim (13)</a></li></ul></nav><nav><h1><a href="/blog/tags/">tags</a></h1><ul><li><a href="/blog/tags/lisp/">lisp (20)</a></li><li><a href="/blog/tags/vim/">vim (14)</a></li><li><a href="/blog/tags/html/">html (10)</a></li><li><a href="/blog/tags/rant/">rant (10)</a></li><li><a href="/blog/tags/unix/">unix (8)</a></li><li><a href="/blog/tags/linux/">linux (5)</a></li><li><a href="/blog/tags/web/">web (4)</a></li><li><a href="/blog/tags/msgpack/">msgpack (3)</a></li><li><a href="/blog/tags/lua/">lua (3)</a></li><li><a href="/blog/tags/guix/">guix (2)</a></li><li><a href="/blog/tags/network/">network (2)</a></li><li><a href="/blog/tags/markdown/">markdown (2)</a></li><li><a href="/blog/tags/cocoa/">cocoa (1)</a></li><li><a href="/blog/tags/info/">info (1)</a></li><li><a href="/blog/tags/awk/">awk (1)</a></li><li><a href="/blog/tags/elixir/">elixir (1)</a></li><li><a href="/blog/tags/neovim/">neovim (1)</a></li><li><a href="/blog/tags/wine/">wine (1)</a></li><li><a href="/blog/tags/games/">games (1)</a></li><li><a href="/blog/tags/git/">git (1)</a></li><li><a href="/blog/tags/terminal/">terminal (1)</a></li></ul></nav></nav></div></div><footer><div><div class="footer-self"><a href="/" title="HiPhish's Workshop"><img src="/img/footer/logo.png" title="HiPhish's Workshop" height="55"/></a><p><a href="http://creativecommons.org/licenses/by-sa/4.0/"><img class="copyright-image" src="/img/footer/cc.svg" alt="Creative Commons Attribution-ShareAlike 4.0 International License"/> </a>© 2015-2022, licensed under <a href="http://creativecommons.org/licenses/by-sa/4.0/">CC BY-SA 4.0</a></p></div><div class="footer-social"><a href="https://github.com/HiPhish" title="GitHub" target="blank"><img src="/img/footer/github.png" alt="GitHub" height="55"/> </a><a href="https://gitlab.com/HiPhish" title="GitLab" target="blank"><img src="/img/footer/gitlab.png" alt="GitLab" height="55"/> </a></div></div></footer></body></html>