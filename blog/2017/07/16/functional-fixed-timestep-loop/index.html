

<!DOCTYPE HTML>
<html lang="en">
	<head>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1" />

		<title>
			HiPhish's Workshop
		</title>
		
		<!-- Bootstrap integration -->
		<link rel="stylesheet"
		href="https://maxcdn.bootstrapcdn.com/bootswatch/3.3.7/flatly/bootstrap.min.css"
		crossorigin="anonymous"/>

		<!-- Bootstrap customisation -->
		<link rel="stylesheet" href="/theme/css/custom.css" type="text/css" media="all"/>

		<!-- My own style sheets -->
		<link rel="stylesheet" href="/theme/css/local-nav.css" type="text/css" media="all"/>
		<link rel="stylesheet" href="/theme/css/pygments.css" type="text/css" media="all"/>
<link rel="stylesheet" href="/theme/css/blog.css" type="text/css" media="all">
	
<link rel="stylesheet" href="/theme/css/article.css" type="text/css" media="all">

		<!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>

		<!-- Bootstrap Javascript -->
		<script
			src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"
			integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa"
		crossorigin="anonymous"></script>
	</head>
	<body>
		<h1>HTML-page body</h1>
		<header>
			<!-- Top navigation bar -->
			<nav id="main-navbar" class="navbar navbar-default">
				<h1>Site-wide navigation bar</h1>
				<!-- Brand and toggle get grouped for better mobile display -->
				<div class="container-fluid">
					<input type="checkbox" value="" name="navbar-toggle-cbox" id="navbar-toggle-cbox"/>
					<!-- Brand and toggle get grouped for better mobile display -->
					<div class="navbar-header">
						<label for="navbar-toggle-cbox" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#main-navbar-collapse" aria-controls="navbar-toggle-cbox">
							<span class="sr-only">Toggle navigation</span>
							<span class="icon-bar"></span>
							<span class="icon-bar"></span>
							<span class="icon-bar"></span>
						</label>
						<a class="navbar-brand" href="http://hiphish.github.io">HiPhish's Workshop</a>
					</div>

					<!-- Collect the nav links, forms, and other content for toggling -->
					<div class="collapse navbar-collapse" id="main-navbar-collapse">
						<!-- The list of navbar items -->
						<ul class="nav navbar-nav">
							<li class="dropdown">
								<a class="dropdown-toggle" href="/grid-framework" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">
									Grid Framework <span></span>								</a>
								<ul class="dropdown-menu">

									<li>
										<a href="http://hiphish.github.io/grid-framework">
											Overview										</a>
									</li>

									<li class="divider" role="separator"></li>

									<li>
										<a href="http://hiphish.github.io/grid-framework/features">
											Features										</a>
									</li>

									<li>
										<a href="http://hiphish.github.io/grid-framework/examples">
											Examples										</a>
									</li>

									<li>
										<a href="http://hiphish.github.io/grid-framework/gallery">
											Gallery										</a>
									</li>

									<li>
										<a href="http://hiphish.github.io/grid-framework/showcase">
											Showcase										</a>
									</li>

									<li>
										<a href="http://hiphish.github.io/grid-framework/faq">
											FAQ										</a>
									</li>

									<li>
										<a href="http://hiphish.github.io/grid-framework/news">
											News										</a>
									</li>

									<li class="divider" role="separator"></li>

									<li>
										<a href="http://forum.unity3d.com/threads/grid-framework-scripting-and-editor-plugins.144886/" target="_blank">
											Support										</a>
									</li>

									<li class="divider" role="separator"></li>

									<li>
										<a href="https://www.assetstore.unity3d.com/#/content/62498" target="_blank">
											Buy Now <span class="badge">35$</span>										</a>
									</li>
								</ul>
							</li>
							<li class="dropdown">
								<a class="dropdown-toggle" href="https://gitlab.com/HiPhish/ntfs-clone" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">
									Open Source <span></span>								</a>
								<ul class="dropdown-menu">

									<li>
										<a href="https://gitlab.com/HiPhish/ntfs-clone" target="_blank">
											NTFS-Clone										</a>
									</li>

									<li>
										<a href="https://gitlab.com/HiPhish/roll" target="_blank">
											roll										</a>
									</li>

									<li>
										<a href="https://github.com/HiPhish/Newton-method" target="_blank">
											Newton's Method in C										</a>
									</li>

									<li>
										<a href="https://github.com/HiPhish/XeenTools" target="_blank">
											Xeen Tools										</a>
									</li>

									<li>
										<a href="https://github.com/HiPhish/Wolf3DExtract" target="_blank">
											Wolf3D Extract										</a>
									</li>

									<li>
										<a href="https://github.com/HiPhish/Game-Source-Documentation" target="_blank">
											Game Source Documentation										</a>
									</li>
								</ul>
							</li>
							<li class="dropdown">
								<a class="dropdown-toggle" href="https://gitlab.com/HiPhish/info.vim" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">
									Nvim/Vim Plugins <span></span>								</a>
								<ul class="dropdown-menu">

									<li>
										<a href="https://gitlab.com/HiPhish/info.vim" target="_blank">
											Info.vim										</a>
									</li>

									<li>
										<a href="https://gitlab.com/HiPhish/repl.nvim" target="_blank">
											REPL.nvim										</a>
									</li>

									<li>
										<a href="https://gitlab.com/HiPhish/jinja.vim" target="_blank">
											jinja.vim										</a>
									</li>
								</ul>
							</li>
						</ul>
						<ul class="nav navbar-nav navbar-right">
								<li class=" ">
									<a href="/blog">
										Blog									</a>
								</li>
								<li class=" ">
									<a href="/about">
										About									</a>
								</li>
						</ul>
					</div>
				</div>
			</nav>
		</header>

		<section class="container">
			<h1>Document body</h1>


<section class="blog-body">
	<h1>Blog</h1>

	<!-- Article body -->
	<section>
<main>
	<nav class="blog-breadcrumbs" aria-label="Breadcrumbs">
	<h1>Breadcrumbs navigation</h1>
	<ol class="breadcrumb">
		<li>
			<a href="http://hiphish.github.io/blog/">
				blog
			</a>
		</li>
		<li>
			<a href="http://hiphish.github.io/blog/2017/">
				2017
			</a>
		<li>
			<a href="http://hiphish.github.io/blog/2017/07/">
				07
			</a>
		<li class="active">
			16
		</li>
		<li class="active">
			functional-fixed-timestep-loop
		</li>
	</ol>
</nav>


	<article>
		<!-- Title of the article -->
		<h1>
			<a href="http://hiphish.github.io/blog/2017/07/16/functional-fixed-timestep-loop/" rel="bookmark" title="Permalink to A purely functional fixed timestep loop">
				A purely functional fixed timestep loop
			</a>
		</h1>

		<header>
<!-- Date of the article -->
			<p>
				<time class="published" datetime="2017-07-16T00:00:00+02:00">
					Published: 2017-07-16
				</time>
			</p>

			<!-- TODO: This has to be something nicer than a button -->
			<p>
				Category:
				<a class="" href="http://hiphish.github.io/blog/categories/misc/">
					misc
				</a>
			</p>
		</header>

		<!-- Content of the article -->
		<p>There is a great article by Glenn Fiedler titled <a class="reference external" href="http://gafferongames.com/game-physics/fix-your-timestep/">“Fix Your Timestep!”</a> in
which the author explains various approaches to writing a game loop and
concludes with a loop that provides a fixed time step for simulation. If you
are not familiar with this topic go read the article first and come back later.
The author has written the implementation in C or C++ using a lot of mutation
and looping, so I wanted to give a purely functional approach a shot.</p>
<p>So why do it the functional way? I like challenging myself and I believe you
need to be able to approach a problem from different angles using different
tools in order to <em>really</em> understand the problem. When I first read the
article a long time ago I was able to understand <em>what</em> the code was doing, but
the reason for <em>why</em> the code was doing it was hard to grasp. What really
helped me understand the method was shifting my perspective from the imperative
mindset to a functional signal-processing mindset.</p>
<p>The language I am using is <a class="reference external" href="http://www.r7rs.org">R7RS</a> Scheme and my implementation is <a class="reference external" href="http://synthcode.com/scheme/chibi/">Chibi-Scheme</a>,
although any implementation conforming to R7RS should be able to run the code.</p>
<div class="section" id="the-fundamental-idea">
<h2>The fundamental idea</h2>
<p>The entire application is driven by a loop: the loop measures time and then
based upon that time it simulates and renders the virtual world. The time in
the virtual world needs to sync up with the time of the real world to create
the illusion of looking through a window. However, the programmer must not fall
into the trap of thinking that the time in the simulation needs to match the
time in the real world, only the output has to match.</p>
<p>What does this mean? It means that the simulation only needs to know how much
virtual time has passed in the simulation so far and by how much virtual time
to advance the simulation. Whether this matches up with the real world or not
does not matter for now.</p>
<div class="highlight"><pre><span></span><span class="p">(</span><span class="k">define </span><span class="p">(</span><span class="nf">simulate</span> <span class="nv">t</span> <span class="nv">Δt</span><span class="p">)</span> <span class="o">...</span><span class="p">)</span>
</pre></div>
<p>This raises the next question: if the simulation is fed the "time" instead of
getting the time itself, where does this "time" come from? The answer is that
there is a function which emits a <code>Δt</code> signal. This signal is then received by
the <code>simulate</code> function.</p>
<div class="highlight"><pre><span></span><span class="c1">;; `t` is the time that has passed so far in the simulation since it was</span>
<span class="c1">;; started, `lag` will be explained later</span>
<span class="p">(</span><span class="k">define </span><span class="p">(</span><span class="nf">emit-Δt-signal</span> <span class="nv">t</span> <span class="nv">lag</span><span class="p">)</span> <span class="o">...</span><span class="p">)</span>
</pre></div>
<p>So what then is calling the emitter function? The game loop. The game loop
measures real time and based on that decides on how many <code>Δt</code> signals to emit.
If the loop is running very quickly (high frame rate) it will emit only a few
signals, and if it runs slowly it will emit multiple <code>Δt</code> signals. The point is
that neither the signal emitter nor the signal receiver need to be concerned
about the state of the clock.</p>
</div>
<div class="section" id="the-code">
<h2>The code</h2>
<p>All code has to be purely functional, this means no mutation and no shared
state. The only exception is the real-world clock because depending on global
state is the entire point of a clock. To simulate frames taking time I will use
a fake clock which advances time by one second every call.</p>
<div class="highlight"><pre><span></span><span class="c1">;;; Returns the "real" time of the physical world. Actually, it just counts up</span>
<span class="c1">;;; from zero, but for our purpose this is simply the real-world clock.</span>
<span class="p">(</span><span class="k">define </span><span class="nv">real-time</span>
  <span class="c1">;; Store the current time as state with initial value zero.</span>
  <span class="p">(</span><span class="k">let </span><span class="p">((</span><span class="nf">time</span> <span class="mi">0</span><span class="p">))</span>
    <span class="p">(</span><span class="k">lambda </span><span class="p">()</span>
      <span class="p">(</span><span class="k">let </span><span class="p">((</span><span class="nf">t</span> <span class="nv">time</span><span class="p">))</span>  <span class="c1">; Store the current time in a temporary variable</span>
        <span class="c1">;; Increment the time, but return the time before increment</span>
        <span class="p">(</span><span class="k">set! </span><span class="nv">time</span> <span class="p">(</span><span class="nb">+ </span><span class="nv">time</span> <span class="p">(</span><span class="nf">jiffies-per-second</span><span class="p">)))</span>
        <span class="nv">t</span><span class="p">))))</span>
</pre></div>
<p>We will also need some fake <code>simulate</code> and <code>render</code> functions:</p>
<div class="highlight"><pre><span></span><span class="c1">;; A real simulation function does not take lag, but we want to show it here</span>
<span class="p">(</span><span class="k">define </span><span class="p">(</span><span class="nf">simulate</span> <span class="nv">t</span> <span class="nv">Δt</span> <span class="nv">lag</span><span class="p">)</span>
  <span class="p">(</span><span class="nb">display </span><span class="s">"Simulating with t="</span><span class="p">)</span>
  <span class="p">(</span><span class="nb">display </span><span class="nv">t</span><span class="p">)</span>
  <span class="p">(</span><span class="nb">display </span><span class="s">", Δt="</span><span class="p">)</span>
  <span class="p">(</span><span class="nb">display </span><span class="nv">Δt</span><span class="p">)</span>
  <span class="p">(</span><span class="nb">display </span><span class="s">", lag="</span><span class="p">)</span>
  <span class="p">(</span><span class="nb">display </span><span class="nv">lag</span><span class="p">)</span>
  <span class="p">(</span><span class="nf">newline</span><span class="p">))</span>

<span class="p">(</span><span class="k">define </span><span class="p">(</span><span class="nf">render</span><span class="p">)</span>
  <span class="p">(</span><span class="nb">display </span><span class="s">"Rendering...\n"</span><span class="p">))</span>
</pre></div>
<p>These just print something to the standard output. Let's now get to the real
meat: the game loop function. Of course it's not a real loop, it's a recursive
function.</p>
<div class="highlight"><pre><span></span><span class="c1">;;; Run the game loop with fixed time step Δt.</span>
<span class="c1">;;;</span>
<span class="c1">;;; Parameters:</span>
<span class="c1">;;;   t         Total simulation time which has passed so far</span>
<span class="c1">;;;   Δt        The fixed tick rate</span>
<span class="c1">;;;   time      Total real-world time since the first iteration</span>
<span class="c1">;;;   lag       How much the simulation is behind real time</span>
<span class="c1">;;;   simulate  Callback to execute on every tick</span>
<span class="c1">;;;   render    Callback to execute every frame</span>
<span class="c1">;;;   quit      Whether to exit the game loop</span>
<span class="p">(</span><span class="k">define </span><span class="p">(</span><span class="nf">run-game-loop</span> <span class="nv">Δt</span> <span class="nv">t</span> <span class="nv">time</span> <span class="nv">lag</span> <span class="nv">simulate</span> <span class="nv">render</span> <span class="nv">quit</span><span class="p">)</span>
</pre></div>
<p>The parameters are in place of what would normally be the state in imperative
programming. <code>t</code> is the total virtual time passed so far, <code>Δt</code> is the fixed
time step. <code>lag</code> is interesting, this is the leftover time that was not
simulated in the previous frame and which will be carried over to the next
frame. <code>simulate</code> and <code>render</code> are our callback functions and <code>quit</code> is a
boolean that tells us whether to exit the loop.</p>
<p>The first item in <code>run-game-loop</code> is the definition of the <code>Δt</code> emitter.</p>
<div class="highlight"><pre><span></span><span class="c1">;; Emit a Δt signal for simulation</span>
<span class="c1">;;</span>
<span class="c1">;; Parameters:</span>
<span class="c1">;;  t    Virtual time that has passed so far in the simulation</span>
<span class="c1">;;  lag  How much the simulation is behind real time</span>
<span class="c1">;;</span>
<span class="c1">;; Returns: The time the simulation has been advanced by and the remaining</span>
<span class="c1">;; lag.</span>
<span class="p">(</span><span class="k">define </span><span class="p">(</span><span class="nf">emit-Δt-signal</span> <span class="nv">t</span> <span class="nv">lag</span><span class="p">)</span>
  <span class="p">(</span><span class="k">if </span><span class="p">(</span><span class="nb">&lt; </span><span class="nv">lag</span> <span class="nv">Δt</span><span class="p">)</span>
    <span class="p">(</span><span class="nb">values </span><span class="nv">t</span> <span class="nv">lag</span><span class="p">)</span>  <span class="c1">; We cannot fit in any more ticks, return</span>
    <span class="p">(</span><span class="nf">begin</span>
      <span class="p">(</span><span class="nf">simulate</span> <span class="nv">t</span> <span class="nv">Δt</span> <span class="nv">lag</span><span class="p">)</span>
      <span class="p">(</span><span class="nf">emit-Δt-signal</span> <span class="p">(</span><span class="nb">+ </span><span class="nv">t</span> <span class="nv">Δt</span><span class="p">)</span> <span class="p">(</span><span class="nb">- </span><span class="nv">lag</span> <span class="nv">Δt</span><span class="p">)))))</span>
</pre></div>
<p>The <code>lag</code> is how much simulation time we have to process. As an example, let's
say our <code>Δt</code> is 50 milliseconds and a frame takes one second, that means we can
fit in 20 <code>Δt</code> signals with no leftover lag. On the other hand, if our frame
rate is 60Hz and <code>Δt</code> 10ms, that means the lag is about 16ms and we can only
fit in one signal.  Furthermore, there are 6ms of lag left which are returned
as the result of the emitter along with the total time simulated.</p>
<p>The emitter will keep pumping out <code>Δt</code> signals as long as it can fit <code>Δt</code>
inside <code>lag</code>. With each iteration it increases the total time simulated <code>t</code> by
<code>Δt</code> and decrease the <code>lag</code> by <code>Δt</code>. When it can no longer fit a <code>Δt</code> inside
the <code>lag</code> it returns the <code>t</code> and <code>lag</code> as return values.</p>
<p>After this function definition comes the body of the game loop function.</p>
<div class="highlight"><pre><span></span><span class="p">(</span><span class="k">let* </span><span class="p">((</span><span class="nf">new-time</span> <span class="p">(</span><span class="nf">real-time</span><span class="p">))</span>
       <span class="c1">;; How long the last frame took to compute</span>
       <span class="p">(</span><span class="nf">frame-time</span> <span class="p">(</span><span class="nb">- </span><span class="nv">new-time</span> <span class="nv">time</span><span class="p">)))</span>
  <span class="p">(</span><span class="nf">let-values</span> <span class="p">(((</span><span class="nf">t</span> <span class="nv">lag</span><span class="p">)</span> <span class="p">(</span><span class="nf">emit-Δt-signal</span> <span class="nv">t</span> <span class="p">(</span><span class="nb">+ </span><span class="nv">lag</span> <span class="nv">frame-time</span><span class="p">))))</span>
    <span class="p">(</span><span class="nf">render</span><span class="p">)</span>
    <span class="p">(</span><span class="k">if </span><span class="nv">quit</span>
      <span class="ss">'done</span>
      <span class="p">(</span><span class="nf">run-game-loop</span>
        <span class="nv">Δt</span>
        <span class="nv">t</span>
        <span class="nv">new-time</span>
        <span class="nv">lag</span>
        <span class="nv">simulate</span>
        <span class="nv">render</span>
        <span class="p">(</span><span class="nb">&gt;= </span><span class="nv">t</span> <span class="p">(</span><span class="nb">* </span><span class="mi">10</span> <span class="p">(</span><span class="nf">jiffies-per-second</span><span class="p">))))))))</span>
</pre></div>
<p>First we measure the current real time when the loop begins, followed by the
time it took for the last frame to finish. This <code>frame-time</code> is the time we
have to simulate, plus whatever leftover <code>lag</code> we had from the previous
iteration. So we start the <code>Δt</code> emitter and store the returned values as the
new <code>t</code> and <code>lag</code>. Finally we render the output and run the next iteration. In
the code above I have set up the <code>quit</code> boolean to be <code>#f</code> after simulating ten
seconds, but in reality you would want the condition to depend on user input or
something more sensible.</p>
<p>Here is what the complete function looks like:</p>
<div class="highlight"><pre><span></span><span class="c1">;;; Run the game loop with fixed time step Δt.</span>
<span class="c1">;;;</span>
<span class="c1">;;; Parameters:</span>
<span class="c1">;;;   t         Total simulation time which has passed so far</span>
<span class="c1">;;;   Δt        The fixed tick rate</span>
<span class="c1">;;;   time      Total real-world time since the first iteration</span>
<span class="c1">;;;   lag       How much the simulation is behind real time</span>
<span class="c1">;;;   simulate  Callback to execute on every tick</span>
<span class="c1">;;;   render    Callback to execute every frame</span>
<span class="c1">;;;   quit      Whether to exit the game loop</span>
<span class="p">(</span><span class="k">define </span><span class="p">(</span><span class="nf">run-game-loop</span> <span class="nv">Δt</span> <span class="nv">t</span> <span class="nv">time</span> <span class="nv">lag</span> <span class="nv">simulate</span> <span class="nv">render</span> <span class="nv">quit</span><span class="p">)</span>

  <span class="c1">;; Emit a Δt signal for simulation</span>
  <span class="c1">;;</span>
  <span class="c1">;; Parameters:</span>
  <span class="c1">;;  t    Virtual time that has passed so far in the simulation</span>
  <span class="c1">;;  lag  How much the simulation is behind real time</span>
  <span class="c1">;;</span>
  <span class="c1">;; Returns: The time the simulation has been advanced by and the remaining</span>
  <span class="c1">;; lag.</span>
  <span class="p">(</span><span class="k">define </span><span class="p">(</span><span class="nf">emit-Δt-signal</span> <span class="nv">t</span> <span class="nv">lag</span><span class="p">)</span>
    <span class="p">(</span><span class="k">if </span><span class="p">(</span><span class="nb">&lt; </span><span class="nv">lag</span> <span class="nv">Δt</span><span class="p">)</span>
      <span class="p">(</span><span class="nb">values </span><span class="nv">t</span> <span class="nv">lag</span><span class="p">)</span>  <span class="c1">; We cannot fit in any more ticks, return</span>
      <span class="p">(</span><span class="nf">begin</span>
        <span class="p">(</span><span class="nf">simulate</span> <span class="nv">t</span> <span class="nv">Δt</span> <span class="nv">lag</span><span class="p">)</span>
        <span class="p">(</span><span class="nf">emit-Δt-signal</span> <span class="p">(</span><span class="nb">+ </span><span class="nv">t</span> <span class="nv">Δt</span><span class="p">)</span> <span class="p">(</span><span class="nb">- </span><span class="nv">lag</span> <span class="nv">Δt</span><span class="p">)))))</span>

  <span class="p">(</span><span class="k">let* </span><span class="p">((</span><span class="nf">new-time</span> <span class="p">(</span><span class="nf">real-time</span><span class="p">))</span>
         <span class="p">(</span><span class="nf">frame-time</span> <span class="p">(</span><span class="nb">- </span><span class="nv">new-time</span> <span class="nv">time</span><span class="p">)))</span> <span class="c1">; How long the last frame took to compute</span>
    <span class="p">(</span><span class="nf">let-values</span> <span class="p">(((</span><span class="nf">t</span> <span class="nv">lag</span><span class="p">)</span> <span class="p">(</span><span class="nf">emit-Δt-signal</span> <span class="nv">t</span> <span class="p">(</span><span class="nb">+ </span><span class="nv">lag</span> <span class="nv">frame-time</span><span class="p">))))</span>
      <span class="p">(</span><span class="nf">render</span><span class="p">)</span>
      <span class="p">(</span><span class="k">if </span><span class="nv">quit</span>
        <span class="ss">'done</span>
        <span class="p">(</span><span class="nf">run-game-loop</span> <span class="nv">Δt</span> <span class="nv">t</span> <span class="nv">new-time</span> <span class="nv">lag</span> <span class="nv">simulate</span> <span class="nv">render</span> <span class="p">(</span><span class="nb">&gt;= </span><span class="nv">t</span> <span class="p">(</span><span class="nb">* </span><span class="mi">10</span> <span class="p">(</span><span class="nf">jiffies-per-second</span><span class="p">))))))))</span>
</pre></div>
<p>Let's take it for a test ride.</p>
<div class="highlight"><pre><span></span><span class="p">(</span><span class="k">let </span><span class="p">((</span><span class="nf">t</span> <span class="mi">0</span> <span class="p">)</span>
      <span class="p">(</span><span class="nf">Δt</span> <span class="p">(</span><span class="nb">/ </span><span class="p">(</span><span class="nf">jiffies-per-second</span><span class="p">)</span> <span class="mi">2</span><span class="p">))</span>
      <span class="p">(</span><span class="nf">time</span> <span class="p">(</span><span class="nf">real-time</span><span class="p">))</span>
      <span class="p">(</span><span class="nf">lag</span> <span class="mi">0</span><span class="p">)</span>
      <span class="p">(</span><span class="nf">quit</span> <span class="no">#f</span><span class="p">))</span>
  <span class="p">(</span><span class="nf">run-game-loop</span> <span class="nv">Δt</span> <span class="nv">t</span> <span class="nv">time</span> <span class="nv">lag</span> <span class="nv">simulate</span> <span class="nv">render</span> <span class="nv">quit</span><span class="p">))</span>
</pre></div>
<p>This will run the loop with two simulations per second.</p>
<pre class="code literal-block">
&gt; (load "loop.scm")
Simulating with t=0, Δt=500, lag=1000
Simulating with t=500, Δt=500, lag=500
Rendering...
Simulating with t=1000, Δt=500, lag=1000
Simulating with t=1500, Δt=500, lag=500
Rendering...
Simulating with t=2000, Δt=500, lag=1000
Simulating with t=2500, Δt=500, lag=500
Rendering...
Simulating with t=3000, Δt=500, lag=1000
Simulating with t=3500, Δt=500, lag=500
Rendering...
Simulating with t=4000, Δt=500, lag=1000
Simulating with t=4500, Δt=500, lag=500
Rendering...
Simulating with t=5000, Δt=500, lag=1000
Simulating with t=5500, Δt=500, lag=500
Rendering...
Simulating with t=6000, Δt=500, lag=1000
Simulating with t=6500, Δt=500, lag=500
Rendering...
Simulating with t=7000, Δt=500, lag=1000
Simulating with t=7500, Δt=500, lag=500
Rendering...
Simulating with t=8000, Δt=500, lag=1000
Simulating with t=8500, Δt=500, lag=500
Rendering...
Simulating with t=9000, Δt=500, lag=1000
Simulating with t=9500, Δt=500, lag=500
Rendering...
Simulating with t=10000, Δt=500, lag=1000
Simulating with t=10500, Δt=500, lag=500
Rendering...
</pre>
<p>As we can see, we get two simulations per frame since each frame is one second.
Let's make it a bit more interesting: a game should run at 60 frames per
second, that's about 16ms per frame. The simulation will run at 50Hz, that's
20ms per <code>Δt</code>. This means that there will be times when we have to skip
simulation for an entire frame until there is enough lag accumulated. In
particular the first frame will only have 16ms of lag.</p>
<div class="highlight"><pre><span></span><span class="c1">;;; Adjusted clock</span>
<span class="p">(</span><span class="k">define </span><span class="nv">real-time</span>
  <span class="p">(</span><span class="k">let </span><span class="p">((</span><span class="nf">time</span> <span class="mi">0</span><span class="p">))</span>
    <span class="p">(</span><span class="k">lambda </span><span class="p">()</span>
      <span class="p">(</span><span class="k">let </span><span class="p">((</span><span class="nf">t</span> <span class="nv">time</span><span class="p">))</span>
        <span class="c1">;; Increment by 1/60th of a second</span>
        <span class="p">(</span><span class="k">set! </span><span class="nv">time</span> <span class="p">(</span><span class="nb">+ </span><span class="nv">time</span> <span class="p">(</span><span class="nf">floor-quotient</span> <span class="p">(</span><span class="nf">jiffies-per-second</span><span class="p">)</span> <span class="mi">60</span><span class="p">)))</span>
        <span class="nv">t</span><span class="p">))))</span>

<span class="c1">;;; Adjusted Δt starting value</span>
<span class="p">(</span><span class="k">let </span><span class="p">((</span><span class="nf">t</span> <span class="mi">0</span> <span class="p">)</span>
      <span class="p">(</span><span class="nf">Δt</span> <span class="p">(</span><span class="nb">/ </span><span class="p">(</span><span class="nf">jiffies-per-second</span><span class="p">)</span> <span class="mi">50</span><span class="p">))</span>
      <span class="p">(</span><span class="nf">time</span> <span class="p">(</span><span class="nf">real-time</span><span class="p">))</span>
      <span class="p">(</span><span class="nf">lag</span> <span class="mi">0</span><span class="p">)</span>
      <span class="p">(</span><span class="nf">quit</span> <span class="no">#f</span><span class="p">))</span>
  <span class="p">(</span><span class="nf">run-game-loop</span> <span class="nv">Δt</span> <span class="nv">t</span> <span class="nv">time</span> <span class="nv">lag</span> <span class="nv">simulate</span> <span class="nv">render</span> <span class="nv">quit</span><span class="p">))</span>
</pre></div>
<p>Here is the output:</p>
<pre class="code literal-block">
&gt; (load "loop.scm")
Rendering...
Simulating with t=0, Δt=20, lag=32
Rendering...
Simulating with t=20, Δt=20, lag=28
Rendering...
Simulating with t=40, Δt=20, lag=24
Rendering...
Simulating with t=60, Δt=20, lag=20
Rendering...
Rendering...
Simulating with t=80, Δt=20, lag=32
Rendering...
Simulating with t=100, Δt=20, lag=28
Rendering...
Simulating with t=120, Δt=20, lag=24
Rendering...
Simulating with t=140, Δt=20, lag=20
Rendering...
Rendering...
Simulating with t=160, Δt=20, lag=32
Rendering...
Simulating with t=180, Δt=20, lag=28
Rendering...
Simulating with t=200, Δt=20, lag=24
Rendering...
Simulating with t=220, Δt=20, lag=20
Rendering...
Rendering...
</pre>
<p>We see that the first frame ran without simulation because there was not enough
lag. The second frame had enough lag for one simulation and left 12ms lag for
the next frame. The third frame had thus 12ms plus its own 16ms for a total of
28ms of lag. As we can see the lag keeps getting shorter and shorter every
frame until in the sixth frame we reach the point where there is not enough lag
and we have to skip simulation for another frame.</p>
</div>
<div class="section" id="conclusion">
<h2>Conclusion</h2>
<p>We now have a purely functional implementation of a game loop with fixed time
step. I haven't bothered to implement the extra interpolation found in the
original article since that only involves the renderer. It is very simple to
compute the interpolation factor:</p>
<div class="highlight"><pre><span></span><span class="c1">;;; Add an α parameter</span>
<span class="p">(</span><span class="k">define </span><span class="p">(</span><span class="nf">render</span> <span class="nv">α</span><span class="p">)</span> <span class="o">...</span><span class="p">)</span>

<span class="c1">;;; Inside the game loop</span>
<span class="p">(</span><span class="nf">render</span> <span class="p">(</span><span class="nb">/ </span><span class="nv">lag</span> <span class="nv">Δt</span><span class="p">))</span>
</pre></div>
<p>Since the lag is less than <code>Δt</code> the <code>α</code> is between zero (inclusive) and one
(exclusive). Another fun idea would have been to make the time increment of
<code>real-time</code> random to simulate a fluctuating frame rate.</p>
<p>In my opinion he functional version is somewhat harder to trace through, but
the underlying idea is easier to see than in the imperative implementation. The
functional nature of my implementation has allowed me to unravel the problem
from inside-out; I started with the <code>simulate</code> function, then asked myself how
to drive that, came up with <code>emit-Δt-signal</code> and finally drove that one by
calling it from <code>run-game-loop</code>. In contrast, in the imperative implementation
Glenn Fiedler started with the game loop and then worked his way down to the
simulation with the fixed time step.</p>
</div>

	</article>

	<footer>
		<!-- Navigation items (next/previous) -->
		<nav>
			<h1>Previous/next article</h1>
			<ul class="pager">
				<li class="previous">
					<a href="http://hiphish.github.io/blog/2017/05/13/mock-repl-unix/" rel="prev">
						<span aria-hidden="true">&larr;</span> Creating a mock REPL on Unix
					</a>
				</li>
				<li class="next">
					<a href="http://hiphish.github.io/blog/2018/12/01/gnu-linux/" rel="next">
						Goodbye macOS, hello GNU/Linux <span aria-hidden="true">&rarr;</span>
					</a>
				</li>
			</ul>
		</nav>
	</footer>
</main>
	</section>

	<!-- "Left" pillar, article navigation -->
	<nav class="well">
		<!-- This navigator contains links to the various archive types. -->
		<h1>Blog navigation</h1>

		<nav>
			<h1>
				<a href="http://hiphish.github.io/blog/archives/">
					Archives
				</a>
			</h1>
			<ul>
				<li>
					<a href="http://hiphish.github.io/blog/2018/">
						2018 (1)
					</a>
				</li>
				<li>
					<a href="http://hiphish.github.io/blog/2017/">
						2017 (4)
					</a>
					<ul>
						<li>
							<a href="http://hiphish.github.io/blog/2017/07/">
								July (1)
							</a>
							<ul>
								<li>
									<a href="http://hiphish.github.io/blog/2017/07/16/functional-fixed-timestep-loop/">
										A purely functional fixed timestep loop
									</a>
								</li>
							</ul>
						</li>
					</ul>
					<ul>
						<li>
							<a href="http://hiphish.github.io/blog/2017/05/">
								May (2)
							</a>
							<ul>
							</ul>
						</li>
					</ul>
					<ul>
						<li>
							<a href="http://hiphish.github.io/blog/2017/04/">
								April (1)
							</a>
							<ul>
							</ul>
						</li>
					</ul>
				</li>
				<li>
					<a href="http://hiphish.github.io/blog/2016/">
						2016 (6)
					</a>
				</li>
				<li>
					<a href="http://hiphish.github.io/blog/2015/">
						2015 (2)
					</a>
				</li>
			</ul>
		</nav>

		<nav>
			<h1>
				<a href="http://hiphish.github.io/blog/categories/">
					Categories
				</a>
			</h1>
			<ul>
				<li>
					<a href="http://hiphish.github.io/blog/categories/ips-tools/">
						ips-tools (1)
					</a>
				</li>
				<li>
					<a href="http://hiphish.github.io/blog/categories/misc/">
						misc (5)
					</a>
				</li>
				<li>
					<a href="http://hiphish.github.io/blog/categories/ntfs-clone/">
						ntfs-clone (1)
					</a>
				</li>
				<li>
					<a href="http://hiphish.github.io/blog/categories/open-source/">
						Open-Source (2)
					</a>
				</li>
				<li>
					<a href="http://hiphish.github.io/blog/categories/organisation/">
						organisation (4)
					</a>
				</li>
			</ul>
		</nav>

		<nav>
			<h1>
				<a href="http://hiphish.github.io/blog/tags/">
					Tags
				</a>
			</h1>
			<ul>
				<li>
					<a href="http://hiphish.github.io/blog/tags/vim/">
						vim (3)
					</a>
				</li>
				<li>
					<a href="http://hiphish.github.io/blog/tags/html/">
						html (1)
					</a>
				</li>
				<li>
					<a href="http://hiphish.github.io/blog/tags/rant/">
						rant (1)
					</a>
				</li>
				<li>
					<a href="http://hiphish.github.io/blog/tags/outline/">
						outline (1)
					</a>
				</li>
				<li>
					<a href="http://hiphish.github.io/blog/tags/info/">
						info (1)
					</a>
				</li>
				<li>
					<a href="http://hiphish.github.io/blog/tags/website/">
						website (3)
					</a>
				</li>
				<li>
					<a href="http://hiphish.github.io/blog/tags/cocoa/">
						cocoa (1)
					</a>
				</li>
			</ul>
		</nav>

		<aside>
			<h1>Subscription options</h1>
			<strong>
				Subscribe:
				<a href="http://hiphish.github.io/blog/rss.xml">RSS</a>
				<a href="http://hiphish.github.io/blog/atom.xml">Atom</a>
			</strong>
		</aside>
	</nav>
</section>
		</section>

		<!-- Footer of the website -->
		<footer>
			<div class="container">
				<div class="col-md-8 footer-self">
					<a href="http://127.0.1.1:8000" title="HiPhish's Workshop">
						<img src="http://hiphish.github.io/images/footer/logo.png" alt="HiPhish's Workshop" />
					</a>
					<p class="text-muted">
						<a href="http://creativecommons.org/licenses/by-sa/4.0/"><img class="copyright-image" alt="Creative Commons Attribution-ShareAlike 4.0International License" src="http://hiphish.github.io/images/footer/cc.svg" /></a>
						© 2015-2018, licensed under <a href="http://creativecommons.org/licenses/by-sa/4.0/">CC BY-SA 4.0</a>
					</p>
				</div>  <!-- /.col-md-8 -->

				<div class="col-md-4 footer-social">
					<span class="pull-right">
						<a href="https://github.com/HiPhish" title="GitHub" target="_blank">
							<img  class="img-circle" src="http://hiphish.github.io/images/footer/github.png" alt="GitHub"/>
						</a>
						<a href="https://gitlab.com/u/HiPhish" title="GitLab" target="_blank">
							<img  class="img-circle" src="http://hiphish.github.io/images/footer/gitlab.png" alt="GitLab"/>
						</a>
					</span>  <!-- /.pull-right -->
				</div>  <!-- /.col-md-4 -->
			</div>
		</footer>
	</body>
</html>

